---
title: Test
output:
  github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
require('knitr')
knitr::opts_chunk$set(echo = FALSE)
options(scipen=999)
source("db_connection.R", local = knitr::knit_global())
source("utils.R", local = knitr::knit_global())
```

```{r, eval=TRUE }
query = "
select operation, response, count(*) as n, count(*) / sum(count(*)) over(partition by operation) as pct
from vw_oas_resource_paths_operations_responses
group by 1,2 order by operation, pct desc
"
df_operations_responses = dbGetQuery(conn, query)
```


```{r, eval=TRUE }
operation = 'get'
df_operations_responses_subset = df_operations_responses[df2$operation == 'get', -1]
```

- Across the `r format_count(sum(df2_operations_responses_subset$n))` responses for `r operation`, the most common response codes or values  are ``r df2_operations_responses_subset$response[1]`` `r format_count_and_pct(df2_operations_responses_subset$n[1], df2_operations_responses_subset$pct[1])`, ``r df2_operations_responses_subset$response[2]`` `r format_count_and_pct(df2_operations_responses_subset$n[2], df2_operations_responses_subset$pct[2])`, ``r df2_operations_responses_subset$response[3]`` `r format_count_and_pct(df2_operations_responses_subset$n[3], df2_operations_responses_subset$pct[3])`, ``r df2_operations_responses_subset$response[4]`` `r format_count_and_pct(df2_operations_responses_subset$n[4], df2_operations_responses_subset$pct[4])`, and ``r df2_operations_responses_subset$response[5]`` `r format_count_and_pct(df2_operations_responses_subset$n[5], df2_operations_responses_subset$pct[5])`


<details>
<summary>Table: Counts and percentages of responses under paths (across all operations)</summary>
```{r, eval=TRUE, echo=FALSE, results='asis'}
kable(df_operations_responses_stacked)
```
</details>


```{r, eval=TRUE }
df_operations_responses_top10 = df_operations_responses[1:10,]
df_operations_responses_other = df_operations_responses[11:nrow(df_operations_responses),] %>% summarize(sum(n),sum(pct))
df_operations_responses_stacked = bind(df_operations_responses_top10, df_operations_responses_other)
```

```{r oas_paths_operations_responses_get, include = TRUE, out.width="90%"}
df$label <- factor(df$label, levels = df$label)
ggplot(df_operations_responses_stacked, aes(x = response, y = n)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.3) +
  ggtitle("Top 10 and other results per operation") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) +
  xlab("Response code or value") +
  ylab("Count responses")
```



